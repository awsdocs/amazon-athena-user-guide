# Amazon Athena CloudWatch connector<a name="connectors-cloudwatch"></a>

The Amazon Athena CloudWatch connector enables Amazon Athena to communicate with CloudWatch so that you can query your log data with SQL\.

The connector maps your LogGroups as schemas and each LogStream as a table\. The connector also maps a special `all_log_streams` view that contains all LogStreams in the LogGroup\. This view enables you to query all the logs in a LogGroup at once instead of searching through each LogStream individually\.

## Prerequisites<a name="connectors-cloudwatch-prerequisites"></a>
+ Deploy the connector to your AWS account using the Athena console or the AWS Serverless Application Repository\. For more information, see [Deploying a connector and connecting to a data source](connect-to-a-data-source-lambda.md) or [Using the AWS Serverless Application Repository to deploy a data source connector](connect-data-source-serverless-app-repo.md)\.

## Parameters<a name="connectors-cloudwatch-parameters"></a>

Use the Lambda environment variables in this section to configure the CloudWatch connector\.
+ **spill\_bucket** – Specifies the Amazon S3 bucket for data that exceeds Lambda function limits\.
+ **spill\_prefix** – \(Optional\) Defaults to a subfolder in the specified `spill_bucket` called `athena-federation-spill`\. We recommend that you configure an Amazon S3 [storage lifecycle](https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lifecycle-mgmt.html) on this location to delete spills older than a predetermined number of days or hours\.
+ **spill\_put\_request\_headers** – \(Optional\) A JSON encoded map of request headers and values for the Amazon S3 `putObject` request that is used for spilling \(for example, `{"x-amz-server-side-encryption" : "AES256"}`\)\. For other possible headers, see [PutObject](https://docs.aws.amazon.com/AmazonS3/latest/API/API_PutObject.html) in the *Amazon Simple Storage Service API Reference*\.
+ **kms\_key\_id** – \(Optional\) By default, any data that is spilled to Amazon S3 is encrypted using the AES\-GCM authenticated encryption mode and a randomly generated key\. To have your Lambda function use stronger encryption keys generated by KMS like `a7e63k4b-8loc-40db-a2a1-4d0en2cd8331`, you can specify a KMS key ID\.
+ **disable\_spill\_encryption** – \(Optional\) When set to `True`, disables spill encryption\. Defaults to `False` so that data that is spilled to S3 is encrypted using AES\-GCM – either using a randomly generated key or KMS to generate keys\. Disabling spill encryption can improve performance, especially if your spill location uses [server\-side encryption](https://docs.aws.amazon.com/AmazonS3/latest/userguide/serv-side-encryption.html)\.

The connector also supports [AIMD congestion control](https://en.wikipedia.org/wiki/Additive_increase/multiplicative_decrease) for handling throttling events from CloudWatch through the [Amazon Athena Query Federation SDK](https://github.com/awslabs/aws-athena-query-federation/tree/master/athena-federation-sdk) `ThrottlingInvoker` construct\. You can tweak the default throttling behavior by setting any of the following optional environment variables:
+ **throttle\_initial\_delay\_ms** – The initial call delay applied after the first congestion event\. The default is 10 milliseconds\.
+ **throttle\_max\_delay\_ms** – The maximum delay between calls\. You can derive TPS by dividing it into 1000ms\. The default is 1000 milliseconds\.
+ **throttle\_decrease\_factor** – The factor by which Athena reduces the call rate\. The default is 0\.5
+ **throttle\_increase\_ms** – The rate at which Athena decreases the call delay\. The default is 10 milliseconds\.

## Databases and tables<a name="connectors-cloudwatch-databases-and-tables"></a>

The Athena CloudWatch connector maps your LogGroups as schemas \(that is, databases\) and each LogStream as a table\. The connector also maps a special `all_log_streams` view that contains all LogStreams in the LogGroup\. This view enables you to query all the logs in a LogGroup at once instead of searching through each LogStream individually\.

Every table mapped by the Athena CloudWatch connector has the following schema\. This schema matches the fields provided by CloudWatch Logs\.
+ **log\_stream** – A `VARCHAR` that contains the name of the LogStream that the row is from\.
+ **time** – An `INT64` that contains the epoch time of when the log line was generated\.
+ **message** – A `VARCHAR` that contains the log message\.

**Examples**  
The following example shows how to perform a `SELECT` query on a specified LogStream\.

```
SELECT * 
FROM "lambda:cloudwatch_connector_lambda_name"."log_group_path"."log_stream_name" 
LIMIT 100
```

The following example shows how to use the `all_log_streams` view to perform a query on all LogStreams in a specified LogGroup\. 

```
SELECT * 
FROM "lambda:cloudwatch_connector_lambda_name"."log_group_path"."all_log_streams" 
LIMIT 100
```

## Required Permissions<a name="connectors-cloudwatch-required-permissions"></a>

Review the `Policies` section of the [athena\-cloudwatch\.yaml](https://github.com/awslabs/aws-athena-query-federation/blob/master/athena-cloudwatch/athena-cloudwatch.yaml) file for full details on the IAM policies that this connector requires\. The following is a brief summary\.
+ **Amazon S3 write access** – To successfully handle large queries, the connector requires write access to a location in Amazon S3\.
+ **Athena GetQueryExecution** – The connector uses this permission to fast\-fail when the upstream Athena query has terminated\.
+ **CloudWatch Logs Read/Write** – The connector uses this permission to read your log data and to write its diagnostic logs\.

## Performance tuning<a name="connectors-cloudwatch-performance-tuning"></a>

The Athena CloudWatch connector attempts to optimize queries against CloudWatch by parallelizing scans of the log streams required for your query\. For certain time period filters, predicate pushdown is performed both within the Lambda function and within CloudWatch Logs\.

## License information<a name="connectors-cloudwatch-license-information"></a>

The Amazon Athena CloudWatch connector project is licensed under the [Apache\-2\.0 License](https://www.apache.org/licenses/LICENSE-2.0.html)\.

## See also<a name="connectors-cloudwatch-see-also"></a>

For additional information about this connector, visit [the corresponding site](https://github.com/awslabs/aws-athena-query-federation/tree/master/athena-cloudwatch) on GitHub\.com\.