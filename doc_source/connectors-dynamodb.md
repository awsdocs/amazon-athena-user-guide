# Amazon Athena DynamoDB connector<a name="connectors-dynamodb"></a>

The Amazon Athena DynamoDB connector enables Amazon Athena to communicate with DynamoDB so that you can query your tables with SQL\. Write operations like [INSERT INTO](insert-into.md) are not supported\.

## Prerequisites<a name="connectors-dynamodb-prerequisites"></a>
+ Deploy the connector to your AWS account using the Athena console or the AWS Serverless Application Repository\. For more information, see [Deploying a connector and connecting to a data source](connect-to-a-data-source-lambda.md) or [Using the AWS Serverless Application Repository to deploy a data source connector](connect-data-source-serverless-app-repo.md)\.

## Parameters<a name="connectors-dynamodb-parameters"></a>

Use the Lambda environment variables in this section to configure the DynamoDB connector\.
+ **spill\_bucket** – Specifies the Amazon S3 bucket for data that exceeds Lambda function limits\.
+ **spill\_prefix** – \(Optional\) Defaults to a subfolder in the specified `spill_bucket` called `athena-federation-spill`\. We recommend that you configure an Amazon S3 [storage lifecycle](https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lifecycle-mgmt.html) on this location to delete spills older than a predetermined number of days or hours\.
+ **spill\_put\_request\_headers** – \(Optional\) A JSON encoded map of request headers and values for the Amazon S3 `putObject` request that is used for spilling \(for example, `{"x-amz-server-side-encryption" : "AES256"}`\)\. For other possible headers, see [PutObject](https://docs.aws.amazon.com/AmazonS3/latest/API/API_PutObject.html) in the *Amazon Simple Storage Service API Reference*\.
+ **kms\_key\_id** – \(Optional\) By default, any data that is spilled to Amazon S3 is encrypted using the AES\-GCM authenticated encryption mode and a randomly generated key\. To have your Lambda function use stronger encryption keys generated by KMS like `a7e63k4b-8loc-40db-a2a1-4d0en2cd8331`, you can specify a KMS key ID\.
+ **disable\_spill\_encryption** – \(Optional\) When set to `True`, disables spill encryption\. Defaults to `False` so that data that is spilled to S3 is encrypted using AES\-GCM – either using a randomly generated key or KMS to generate keys\. Disabling spill encryption can improve performance, especially if your spill location uses [server\-side encryption](https://docs.aws.amazon.com/AmazonS3/latest/userguide/serv-side-encryption.html)\.
+ **disable\_glue** – \(Optional\) If present and set to true, the connector does not attempt to retrieve supplemental metadata from AWS Glue\.
+ **glue\_catalog** – \(Optional\) Use this option to specify a [cross\-account AWS Glue catalog](data-sources-glue-cross-account.md)\. By default, the connector attempts to get metadata from its own AWS Glue account\.
+ **disable\_projection\_and\_casing** – \(Optional\) Disables projection and casing\. Use if you want to query DynamoDB tables that have casing in their column names and you do not want to specify a `columnMapping` property on your AWS Glue table\.

  The `disable_projection_and_casing` parameter uses the following values to specify the behavior of casing and column mapping:
  + **auto** – Disables projection and casing when a previously unsupported type is detected and column name mapping is not set on the table\. This is the default setting\.
  + **always** – Disables projection and casing unconditionally\. This is useful when you have casing in your DynamoDB column names but do not want to specify any column name mapping\.

  When using the `disable_projection_and_casing` parameter, keep in mind the following points:
  + Use of the parameter can result in higher bandwidth usage if your Lambda function is not in the same region as your DynamoDB table\.
  + Because a larger number of bytes is transferred and because the larger number of bytes requires a higher deserialization time, overall latency can increase\.

## Setting up databases and tables in AWS Glue<a name="connectors-dynamodb-setting-up-databases-and-tables-in-aws-glue"></a>

Because the connector's built\-in schema inference capability is limited, you might want to use AWS Glue for metadata\. To enable an AWS Glue table for use with DynamoDB, you must have an AWS Glue table for the DynamoDB table that you want to supply supplemental metadata for\.

**To use an AWS Glue table for supplemental metadata**

1. When you edit the table and database in the AWS Glue console, add the following table properties as required\. If you use the AWS Glue DynamoDB crawler, these properties are automatically set\.
   + **dynamodb** – String that indicates to the Athena DynamoDB connector that the table can be used for supplemental metadata\. You can enter the `dynamodb` string in any one of the following places:
     + In the table properties under a field called **classification** \(exact match\)\.
     + In the table storage descriptor **location** field \(sub\-string match\)\.
     + In the table storage descriptor parameters under a field called **classification** \(exact match\)\.
   + **dynamo\-db\-flag** – String that indicates that the database contains tables that the Athena DynamoDB connector is using for supplemental metadata\. This is required for AWS Glue databases other than `default`\. The `dynamo-db-flag` property is useful for filtering out irrelevant databases in accounts that have many of them\. This string should be in the **Location URI** of the AWS Glue database \(sub\-string match\)\.
   + **sourceTable** – Optional table property that defines the source table name in DynamoDB\. Use this if AWS Glue table naming rules prevent you from creating a AWS Glue table with the same name as your DynamoDB table\. For example, capital letters are not permitted in AWS Glue table names, but they are permitted in DynamoDB table names\.
   + **columnMapping** – Optional table property that defines column name mappings\. Use this if AWS Glue column naming rules prevent you from creating a AWS Glue table with the same column names as your DynamoDB table\. For example, capital letters are not permitted in AWS Glue column names but are permitted in DynamoDB column names\. The property value is expected to be in the format col1=Col1,col2=Col2\. Note that column mapping applies only to top level column names and not to nested fields\.
   + **defaultTimeZone** – Optional table property that is applied to `date` or `datetime` values that do not have an explicit time zone\. Setting this value is a good practice to avoid discrepancies between the data source default time zone and the Athena session time zone\.
   + **datetimeFormatMapping** – Optional table property that specifies the `date` or `datetime` format to use when parsing data from a column of the AWS Glue `date` or `timestamp` data type\. If this property is not specified, the connector attempts to [infer](https://commons.apache.org/proper/commons-lang/apidocs/org/apache/commons/lang3/time/DateFormatUtils.html) an ISO\-8601 format\. If the connector cannot infer the `date` or `datetime` format or parse the raw string, then the value is omitted from the result\. 

     The `datetimeFormatMapping` value should be in the format `col1=someformat1,col2=someformat2`\. Following are some example formats:

     ```
     yyyyMMdd'T'HHmmss 
     ddMMyyyy'T'HH:mm:ss
     ```

     If your column has `date` or `datetime` values without a time zone and you want to use the column in the `WHERE` clause, set the `datetimeFormatMapping` property for the column\.

1. If you define your columns manually, make sure that you use the appropriate data types\. If you used a crawler, validate the columns and types that the crawler discovered\.

## Required Permissions<a name="connectors-dynamodb-required-permissions"></a>

Review the `Policies` section of the [athena\-dynamodb\.yaml](https://github.com/awslabs/aws-athena-query-federation/blob/master/athena-dynamodb/athena-dynamodb.yaml) file for full details on the IAM policies that this connector requires\. The following is a brief summary\.
+ **Amazon S3 write access** – To successfully handle large queries, the connector requires write access to a location in Amazon S3\.
+ **Athena GetQueryExecution** – The connector uses this permission to fast\-fail when the upstream Athena query has terminated\.
+ **AWS Glue Data Catalog** – The DynamoDB connector requires read only access to the AWS Glue Data Catalog to obtain schema information\.
+ **CloudWatch Logs** – The connector requires access to CloudWatch Logs for storing logs\.
+ **DynamoDB read access** – The connector uses the `DescribeTable`, `ListSchemas`, `ListTables`, `Query`, and `Scan` API operations\.

## Performance<a name="connectors-dynamodb-performance"></a>

The Athena DynamoDB connector supports parallel scans and attempts to push down predicates as part of its DynamoDB queries\. A hash key predicate with `X` distinct values results in `X` Query calls to DynamoDB\. All other predicate scenarios result in `Y` number of scan calls, where `Y` is heuristically determined based on the size of your table and its provisioned throughput\.

Predicate pushdown is performed within the Lambda function to decrease the data scanned by the query\. However, selecting a subset of columns sometimes results in longer query execution runtime\. `LIMIT` clauses reduce the amount of data scanned, but if a predicate is not provided, you should expect `SELECT` queries with a `LIMIT` clause to scan at least 16mb of data\.

The DynamoDB connector scans more data for larger datasets than for smaller datasets regardless of the `LIMIT` clause applied\. For example, the query `SELECT * LIMIT 10000` scans more data for a larger underlying dataset than a smaller underlying dataset\.

## Costs<a name="connectors-dynamodb-costs"></a>

The costs for use of the connector depends on the underlying AWS resources that are used\. Because queries that use scans can consume a large number of [read capacity units \(RCUs\)](http://aws.amazon.com/dynamodb/pricing/provisioned/), consider the information for [Amazon DynamoDB pricing](http://aws.amazon.com/dynamodb/pricing/) carefully\.

## See also<a name="connectors-dynamodb-see-also"></a>

For additional information about this connector, visit [the corresponding site](https://github.com/awslabs/aws-athena-query-federation/tree/master/athena-dynamodb) on GitHub\.com\.